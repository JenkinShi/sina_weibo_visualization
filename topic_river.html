<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Drawing Curves</title>
	<script type="text/javascript" src="./js/topic_river.js"></script>
</head>
<body>
<button id="next_step">单步</button>
<button id="go_on">执行</button>
<button id="stop">停止</button>
<div id="topic_river"></div>
<div id="weibo_frame" style="position: absolute; right: 50px; top: 445px; width:420px;height:260px; border: 1px solid #adeaea; padding-left: 20px; padding-right: 20px; font-size: 15px">
	<iframe frameborder="no" src="" height="100%" width="100%"></iframe>
</div>
</body>
<script type="text/javascript">

	function init_graph(data){
		var settings = {
			has_detail_graph:true,
			graph_height:300,
			graph_width:1250,
			text_height:90,
			comment_height:30,
			detail_graph_height:260,
			topic_count:10,
			per_river_data_num:21,
			archive_data_num:6,
			max_sum_data:8000000,
			max_data:1200000,
			ball_move_time:600,
			ball_small_time:400,
			comment_name:"话题名称",
			father_id:"topic_river",

		};
		var init_data = {
			archive:data['archive_data'],
			river:data['river_data'],
			river_time:data['river_time'],
			archive_time:data['archive_time']
		}
		tg.create(settings).init(init_data);
		tg.addFuncGetWordCloud(get_word_cloud);
		tg.addFuncOnClickEvent(onClickEvent);

		

		function get_word_cloud(name,time_start,time_end){
			var word_cloud;
			$.post("./wordclouddata.php", 
				{
					topic:name,
					time_start:time_start,
					time_end:time_end
				}, 
        		function(data,status){
        			if("success" == status){
	        			// alert(data);
	        			word_cloud = JSON.parse(data)['word_cloud'];
	        			tg.add_word_cloud(word_cloud);
	        		}
	        		else{
	        			alert("数据加载异常！");
	        		}
	        	}
        	);
		}
		
		function onClickEvent(name,time_start,time_end){

			var url = "./weibocontent.php?topic="+name+"&time_start="+time_start+"&time_end="+time_end;
			d3.select("#weibo_frame")
				.select("iframe")
				.attr("src",url);
		}
	}

	
	function add_token(){
		$.post("./tokendata.php", "", 
        	function(data,status){
        		if("success" == status){
        			var token_data = JSON.parse(data);
        			tg.addToken(
        				token_data
					);
        		}
        		else{
        			alert("数据加载异常！");
        		}
        	}
        );
    }

	$(document).ready(function(){
        $.post("./initdata.php", "", 
        	function(data,status){
        		if("success" == status){
        			init_graph(JSON.parse(data));
        		}
        		else{
        			alert("数据加载异常！");
        		}
        	}
        );
        var tokenOn;

        d3.select("#next_step").on("click",function(){
        	add_token();
        });
        d3.select("#go_on").on("click",function(){
        	tokenOn = setInterval(add_token,1100);
        });
        d3.select("#stop").on("click",function(){
        	clearInterval(tokenOn);
        });
	})
	
</script>
</html>